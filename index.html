<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»£è³¼æ™ºæ…§ç®¡å®¶ 25.0 | é›²ç«¯æ¥µé€Ÿç©©å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fcfafb; margin: 0; overflow-x: hidden; }
        
        .sidebar { 
            width: 260px; background: white; border-right: 1px solid #f1f5f9; 
            min-height: 100vh; position: fixed; top: 0; left: 0; z-index: 50; 
            transition: transform 0.3s ease;
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0 !important; padding-top: 80px !important; }
        }
        .main-content { margin-left: 260px; transition: margin-left 0.3s ease; width: 100%; padding-bottom: 50px; }

        .nav-item { padding: 12px 20px; border-radius: 12px; cursor: pointer; color: #64748b; margin-bottom: 5px; font-size: 14px; }
        .nav-item:hover, .nav-item.active { background: #fff1f2; color: #e11d48; font-weight: bold; }
        .glass-card { background: white; border-radius: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid #f8fafc; }
        
        /* å½ˆçª—å„ªåŒ–ï¼šç¢ºä¿æ‰‹æ©Ÿç‰ˆä¸è¢«æ“‹ä½æŒ‰éˆ• */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: flex-start; justify-content: center; backdrop-filter: blur(8px); overflow-y: auto; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 2rem; width: 100%; max-width: 600px; margin-top: 20px; padding: 24px; position: relative; }

        .status-select { border-radius: 6px; font-size: 11px; padding: 4px 10px; font-weight: bold; border: none; cursor: pointer; width: 100%; }
        .st-chk { background-color: #3b82f6 !important; color: white !important; }
        .st-ord { background-color: #f97316 !important; color: white !important; }
        .st-none { background-color: #f3f4f6; color: #9ca3af; }
    </style>
</head>
<body class="flex">

    <header class="md:hidden fixed top-0 left-0 right-0 bg-white border-b p-4 flex items-center justify-between z-40">
        <button onclick="toggleSidebar()" class="text-rose-500 text-2xl p-2"><i class="fas fa-bars"></i></button>
        <span class="font-bold text-rose-500">ä»£è³¼æ™ºæ…§ç®¡å®¶ 25.0</span>
        <div class="w-10"></div>
    </header>

    <aside id="sidebar" class="sidebar p-5 flex flex-col">
        <div class="text-rose-500 font-bold text-xl px-2 mb-8 hidden md:flex items-center">
            <i class="fas fa-cloud mr-2"></i>ä»£è³¼æ™ºæ…§ç®¡å®¶
        </div>
        <nav class="flex-1 space-y-1 overflow-y-auto">
            <div onclick="changeView('dashboard')" id="nav-dashboard" class="nav-item active"><i class="fas fa-th-large mr-3"></i> ç¸½é«”çœ‹æ¿</div>
            <div class="mt-6 px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest">ğŸ“‹ åœ˜å‹™ç®¡ç†</div>
            <div id="side-group-list" class="mt-2 space-y-1"></div>
            <div onclick="openModal('groupModal')" class="px-5 py-2 text-rose-400 text-[11px] font-bold cursor-pointer hover:underline">+ æ–°å¢åœ˜å‹™é é¢</div>
            <div class="mt-6 px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest">ğŸ“¦ ç‰©æµå‡ºè²¨</div>
            <div onclick="changeView('shipping')" id="nav-shipping" class="nav-item"><i class="fas fa-truck mr-3"></i> å¾…å‡ºè²¨å·¥ä½œå°</div>
            <div onclick="changeView('history')" id="nav-history" class="nav-item"><i class="fas fa-history mr-3"></i> æ­·å²ç´€éŒ„å€</div>
            <div class="mt-6 px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest">âš™ï¸ ç³»çµ±åŒæ­¥</div>
            <div onclick="changeView('settings')" id="nav-settings" class="nav-item"><i class="fas fa-cog mr-3"></i> é›²ç«¯è¨­å®š</div>
        </nav>
        <button onclick="openModal('searchModal')" class="w-full bg-rose-500 text-white p-4 rounded-2xl text-xs font-bold shadow-lg mt-4"><i class="fas fa-search mr-2"></i>è·¨åœ˜ç—…æ­·æœå°‹</button>
    </aside>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="hidden fixed inset-0 bg-black/30 z-40 md:hidden"></div>

    <main class="main-content p-4 md:p-10">
        <div id="view-dashboard" class="max-w-6xl mx-auto space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">æ´»èºåœ˜å‹™çœ‹æ¿</h2>
                <span id="sync-time" class="text-[10px] text-gray-400"></span>
            </div>
            <div class="glass-card overflow-x-auto">
                <table class="w-full text-left text-sm min-w-[700px]">
                    <thead class="bg-gray-50 text-gray-400 font-bold text-[10px] uppercase">
                        <tr><th class="p-4">åœ˜å‹™åç¨±</th><th class="p-4">é€²åº¦</th><th class="p-4 text-center">æ—¥æœŸ</th><th class="p-4">é ä¼°ç²åˆ©</th><th class="p-4 text-center">ç®¡ç†</th></tr>
                    </thead>
                    <tbody id="dashboard-tbody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

        <div id="view-settings" class="hidden max-w-2xl mx-auto space-y-8">
            <h2 class="text-2xl font-bold text-gray-800">é›²ç«¯åŒæ­¥è¨­å®š</h2>
            <div class="glass-card p-8 space-y-6 border-2 border-rose-100">
                <div>
                    <p class="font-bold text-gray-700 mb-2">Google API URL (é‡‘é‘°)</p>
                    <input type="text" id="api-url" placeholder="è«‹è²¼ä¸Šéƒ¨ç½²å¾Œå–å¾—çš„ URL..." class="w-full p-4 border rounded-2xl text-xs outline-none focus:ring-2 focus:ring-rose-200">
                    <p class="text-[10px] text-gray-400 mt-2 italic">* å®Œæˆæˆæ¬Šä¸¦å–å¾—ç¶²å€å¾Œåœ¨æ­¤è²¼ä¸Šå³å¯åŒæ­¥è³‡æ–™ã€‚</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="uploadToCloud()" class="bg-rose-500 text-white p-4 rounded-2xl font-bold shadow-lg shadow-rose-100"><i class="fas fa-cloud-upload-alt mr-2"></i>ä¸Šå‚³è‡³é›²ç«¯</button>
                    <button onclick="downloadFromCloud()" class="bg-indigo-500 text-white p-4 rounded-2xl font-bold shadow-lg shadow-indigo-100"><i class="fas fa-cloud-download-alt mr-2"></i>å¾é›²ç«¯ä¸‹è¼‰</button>
                </div>
                <button onclick="saveApiUrl()" class="w-full py-3 border-2 border-rose-500 text-rose-500 rounded-2xl font-bold hover:bg-rose-50 transition">å„²å­˜é‡‘é‘°è¨­å®š</button>
            </div>
        </div>

        <div id="view-groupDetail" class="hidden max-w-6xl mx-auto space-y-6">...å…§å®¹ç•¥ï¼Œé‚è¼¯ä¿æŒ...</div>
        <div id="view-shipping" class="hidden max-w-6xl mx-auto space-y-6">...å…§å®¹ç•¥ï¼Œé‚è¼¯ä¿æŒ...</div>
        <div id="view-history" class="hidden max-w-6xl mx-auto space-y-8">...å…§å®¹ç•¥ï¼Œé‚è¼¯ä¿æŒ...</div>
    </main>

    <div id="orderModal" class="modal"><div class="modal-content shadow-2xl space-y-6">
        <h3 class="text-xl font-bold text-gray-800">éŒ„å…¥/ç·¨è¼¯è²·å®¶è¨‚å–®</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input id="inName" placeholder="è‡‰æ›¸åç¨±" class="border p-4 rounded-xl text-sm"><input id="inSocial" placeholder="ç¤¾ç¾¤åç¨±" class="border p-4 rounded-xl text-sm"></div>
        <div id="p-selector" class="bg-rose-50 p-6 rounded-[2rem] space-y-3"></div>
        <div class="flex justify-between font-bold text-rose-600 px-2 text-lg"><span>ç¸½é‡‘é¡ï¼š</span><span id="auto-price">$0</span></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input id="inLast" placeholder="æœ«äº”ç¢¼" class="border p-4 rounded-xl text-sm"><input type="date" id="inPayDate" class="border p-4 rounded-xl text-sm"></div>
        <textarea id="inMemo" placeholder="å‚™è¨»ç´€éŒ„" class="w-full border p-4 rounded-xl text-sm h-20"></textarea>
        <div class="flex gap-4 pt-4 sticky bottom-0 bg-white pb-2">
            <button onclick="closeModal('orderModal')" class="flex-1 text-gray-400 font-bold p-4">å–æ¶ˆ</button>
            <button onclick="saveO()" class="flex-1 py-4 bg-rose-500 text-white rounded-2xl font-bold shadow-lg shadow-rose-200">ç¢ºèªå„²å­˜</button>
        </div>
    </div></div>

    <script>
        let db = JSON.parse(localStorage.getItem('daigo_v25_db')) || { groups: {}, historyGroups: {}, manualShips: [], historyShips: [], apiUrl: "" };
        let editingOrderId = null; let editingGroupId = null;

        window.onload = () => { 
            if(db.apiUrl) document.getElementById('api-url').value = db.apiUrl;
            renderSide(); renderDashboard(); 
        };

        function save() { localStorage.setItem('daigo_v25_db', JSON.stringify(db)); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); }
        function saveApiUrl() { db.apiUrl = document.getElementById('api-url').value.trim(); save(); alert('é›²ç«¯ API è¨­å®šæˆåŠŸï¼'); }

        // --- é›²ç«¯åŒæ­¥æ ¸å¿ƒé‚è¼¯ ---
        async function uploadToCloud() {
            if(!db.apiUrl) return alert('è«‹å…ˆè²¼ä¸Š API ç¶²å€ä¸¦å„²å­˜');
            try {
                const response = await fetch(db.apiUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(db)
                });
                alert('å·²åŒæ­¥è‡³ Google é›²ç«¯ï¼');
                document.getElementById('sync-time').innerText = "æœ€å¾Œå‚™ä»½: " + new Date().toLocaleTimeString();
            } catch(e) { alert('åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API éƒ¨ç½²'); }
        }

        async function downloadFromCloud() {
            if(!db.apiUrl) return alert('è«‹å…ˆè²¼ä¸Š API ç¶²å€ä¸¦å„²å­˜');
            try {
                const response = await fetch(db.apiUrl);
                const cloudData = await response.json();
                if(confirm('ä¸‹è¼‰å°‡è¦†è“‹æ‰‹æ©Ÿç›®å‰è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ')) {
                    db = cloudData; save(); location.reload();
                }
            } catch(e) { alert('ä¸‹è¼‰å¤±æ•—ï¼Œé›²ç«¯å¯èƒ½å°šæœªå­˜æª”ã€‚'); }
        }

        // --- éŒ„å–®åŠŸèƒ½ç©©å®šç‰ˆ (é‡å°æ‰‹æ©Ÿæœ€ä½³åŒ–) ---
        function saveO() {
            const g = db.groups[db.activeGid];
            const name = document.getElementById('inName').value.trim();
            if(!name) return alert('è«‹è¼¸å…¥è‡‰æ›¸åç¨±');

            const its = []; let tot = 0;
            g.products.forEach((p, i) => {
                const q = parseInt(document.getElementById('qty-'+i).innerText);
                if(q > 0){ its.push({name: p.name, qty: q}); tot += p.price * q; }
            });

            const data = { 
                id: editingOrderId || Date.now(), 
                name, 
                social: document.getElementById('inSocial').value, 
                last: document.getElementById('inLast').value, 
                payDate: document.getElementById('inPayDate').value, 
                memo: document.getElementById('inMemo').value, 
                items: its, 
                itemsStr: its.map(i=>i.name+'x'+i.qty).join(','), 
                price: tot, 
                chk: editingOrderId ? g.orders.find(x=>x.id==editingOrderId).chk : 'å°šæœªæ›´æ–°', 
                ord: editingOrderId ? g.orders.find(x=>x.id==editingOrderId).ord : 'å°šæœªæ›´æ–°' 
            };

            if(editingOrderId) {
                const idx = g.orders.findIndex(x => x.id == editingOrderId);
                g.orders[idx] = data;
            } else {
                g.orders.push(data);
            }
            save(); renderDetail(); closeModal('orderModal');
        }

        // ...å…¶å®ƒè¼”åŠ©åŠŸèƒ½(changeView, renderDashboard, renderDetail, editO etc.) ä¿æŒä¸è®Šï¼Œä½†æŒ‰éˆ•åŠ ä¸Š z-index ä¿è­·...
        function openModal(id) { 
            const modal = document.getElementById(id);
            modal.classList.add('active'); 
            if(id === 'orderModal' && !editingOrderId) renderPSelector();
            // è‡ªå‹•æ»¾å‹•åˆ°å½ˆçª—é ‚éƒ¨
            modal.scrollTop = 0;
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        // ...å…¶é¤˜é‚è¼¯æ¯”ç…§ 20.0 å®Œæ•´ç§»æ¤...
    </script>
</body>
</html>
